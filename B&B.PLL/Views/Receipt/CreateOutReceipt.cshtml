@using B_B.BLL.ViewModels
@model OutReceiptVM

<div class="page-content active">
    <div class="page-header">
        <h1 class="page-title">إنشاء إيصال خروج</h1>
        <a asp-action="OutReceipts" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> رجوع
        </a>
    </div>

    <div class="content-section">
        <div asp-validation-summary="All" class="text-danger"></div>

        <form asp-action="CreateOutReceipt" method="post">
            <!-- Client selection -->
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">اختر عميل موجود</label>
                    <select asp-for="ClientId" asp-items="Model.Clients" class="form-input">
                        <option value="">-- عميل جديد --</option>
                    </select>
                    <span asp-validation-for="ClientId" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">اسم العميل الجديد</label>
                    <input asp-for="NewClientName" class="form-input" placeholder="ادخل الاسم إذا كان العميل جديد" />
                    <span asp-validation-for="NewClientName" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">هاتف العميل الجديد</label>
                    <input asp-for="NewClientPhone" class="form-input" placeholder="رقم الهاتف اختياري" />
                    <span asp-validation-for="NewClientPhone" class="text-danger"></span>
                </div>
            </div>

            <!-- Plumber selection -->
            <div class="form-grid mt-4">
                <div class="form-group">
                    <label class="form-label">اختر سباك موجود</label>
                    <select asp-for="PlumberId" asp-items="Model.Plumbers" class="form-input">
                        <option value="">-- سباك جديد --</option>
                    </select>
                    <span asp-validation-for="PlumberId" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">اسم السباك الجديد</label>
                    <input asp-for="NewPlumberName" class="form-input" placeholder="ادخل الاسم إذا كان السباك جديد" />
                    <span asp-validation-for="NewPlumberName" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">هاتف السباك الجديد</label>
                    <input asp-for="NewPlumberPhone" class="form-input" placeholder="رقم الهاتف اختياري" />
                    <span asp-validation-for="NewPlumberPhone" class="text-danger"></span>
                </div>
            </div>

            <!-- Product search -->
            <div class="form-group">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchBox" class="search-input" placeholder="ابحث عن المنتجات..." />
                </div>
            </div>

            <!-- Products table -->
            <div class="table-container">
                <table class="table" id="productTable">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>التكلفة</th>
                            <th>سعر البيع</th>
                            <th>المخزون</th>
                            <th>الإجراء</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav>
                <ul class="pagination" id="pagination"></ul>
            </nav>
            <div class="pagination-info" id="paginationInfo"></div>

            <!-- Receipt details -->
            <h4 class="mt-4 section-title">تفاصيل الإيصال</h4>
            <div class="table-container">
                <table class="table" id="receiptDetailsTable">
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th>الكمية</th>
                            <th>التكلفة</th>
                            <th>سعر الوحدة</th>
                            <th>نسبة الخصم (%)</th>
                            <th>الإجمالي بعد الخصم</th>
                            <th>الإجراء</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Totals -->
            <div class="form-grid mt-3">
                <div class="form-group">
                    <label class="form-label"><strong>الإجمالي الكلي:</strong></label>
                    <div class="form-control-static" id="grandTotal">0.00</div>
                </div>
                <div class="form-group">
                    <label class="form-label"><strong>إجمالي التكلفة:</strong></label>
                    <div class="form-control-static" id="costTotal">0.00</div>
                </div>
                <div class="form-group">
                    <label class="form-label">المبلغ المدفوع</label>
                    <input type="number" asp-for="PaidAmount" id="PaidAmount" class="form-input" value="0" min="0" step="0.01" />
                    <span asp-validation-for="PaidAmount" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label class="form-label"><strong>المتبقي (المدين):</strong></label>
                    <div class="form-control-static" id="remainingAmount">0.00</div>
                </div>
            </div>

            <div class="action-buttons mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> حفظ الإيصال
                </button>
                <a asp-action="OutReceipts" class="btn btn-secondary">إلغاء</a>
            </div>
        </form>
    </div>
</div>

@{
    // Safe JSON strings for JS
    var productsJson = ViewBag.ProductsJson as string ?? "[]";
    var details = Model?.ReceiptDetails ?? new List<ReceiptDetailVM>();

    // 🔥 ENHANCED: Serialize with all necessary properties
    var detailsJson = System.Text.Json.JsonSerializer.Serialize(
        details.Select(d => new
        {
            ProductId = d.ProductId,
            ProductName = d.ProductName,
            Quantity = d.Quantity,
            UnitPrice = d.UnitPrice,
            Cost = d.Cost,
            DiscountPercentage = d.DiscountPercentage
        }),
        new System.Text.Json.JsonSerializerOptions
        {
            Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
        }
    );
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

    <script>
        var products = @Html.Raw(productsJson);
        var savedDetails = @Html.Raw(detailsJson);

        let pageSize = 20, currentPage = 1, detailIndex = 0, maxVisiblePages = 5;

        /* ----------------------- PRODUCT LIST ----------------------- */

        function renderProducts() {
            let search = $("#searchBox").val()?.toLowerCase() || "";
            let filtered = products.filter(p => (p.name || "").toLowerCase().includes(search));
            let totalItems = filtered.length;
            let totalPages = Math.ceil(totalItems / pageSize);
            let start = (currentPage - 1) * pageSize;
            let paged = filtered.slice(start, start + pageSize);

            let rows = paged.map(p => `
                <tr>
                    <td>${escapeHtml(p.name)}</td>
                    <td>${p.cost ?? 0}</td>
                    <td>${p.price ?? 0}</td>
                    <td>${p.stock ?? 0}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-success addProductBtn"
                            data-id="${p.id}"
                            data-name="${escapeHtml(p.name)}"
                            data-price="${p.price ?? 0}"
                            data-cost="${p.cost ?? 0}">
                            <i class="fas fa-plus"></i> إضافة
                        </button>
                    </td>
                </tr>`).join("");

            $("#productTable tbody").html(rows);
            renderPagination(totalPages, totalItems);
        }

        function renderPagination(totalPages, totalItems) {
            if (totalPages <= 1) {
                $("#pagination").html("");
                $("#paginationInfo").text(`عرض 1-${totalItems} من ${totalItems} منتج`);
                return;
            }

            const startItem = (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(currentPage * pageSize, totalItems);
            $("#paginationInfo").text(`عرض ${startItem}-${endItem} من ${totalItems} منتج`);

            let html = `<li class="page-item ${currentPage===1?'disabled':''}">
                            <a class="page-link" href="#" data-page="prev">&lt;</a>
                        </li>`;

            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages/2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i===currentPage?'active':''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                         </li>`;
            }

            html += `<li class="page-item ${currentPage===totalPages?'disabled':''}">
                        <a class="page-link" href="#" data-page="next">&gt;</a>
                     </li>`;

            $("#pagination").html(html);
        }

        $(document).on("click", "#pagination a", function(e){
            e.preventDefault();
            const action = $(this).data("page");
            const filtered = products.filter(p => (p.name||"").toLowerCase().includes($("#searchBox").val().toLowerCase()));
            const totalPages = Math.ceil(filtered.length / pageSize);

            if(action === "prev" && currentPage > 1) currentPage--;
            else if(action === "next" && currentPage < totalPages) currentPage++;
            else if(!isNaN(action)) currentPage = parseInt(action);

            renderProducts();
        });

        $("#searchBox").on("input", () => {
            currentPage = 1;
            renderProducts();
        });

        /* ----------------------- ADD ROW ----------------------- */

        $(document).on("click", ".addProductBtn", function(){
            let productId = $(this).data("id"),
                productName = $(this).data("name"),
                price = $(this).data("price") ?? 0,
                cost = $(this).data("cost") ?? 0;

            let existingRow = $(`#receiptDetailsTable tbody tr[data-id='${productId}']`);
            if(existingRow.length > 0){
                let qtyInput = existingRow.find(".qty");
                qtyInput.val((parseFloat(qtyInput.val() || 0) + 1)).trigger("input");
            } else {
                addProductRow(productId, productName, 1, price, cost, 0, 0);
            }
            saveDraft();
        });

        function addProductRow(id, name, qty, price, cost, discount, refund){
            const safeName = escapeHtml(name);
            let row = `
            <tr data-id="${id}" data-cost="${cost}">
                <td>
                    <input type="hidden" name="ReceiptDetails[${detailIndex}].ProductId" value="${id}" />
                    ${safeName}
                </td>
                <td><input type="number" name="ReceiptDetails[${detailIndex}].Quantity" value="${qty}"
                           class="form-input qty" min="0" step="0.001" /></td>

                <td class="rowCost">${cost}</td>

                <td><input type="number" name="ReceiptDetails[${detailIndex}].UnitPrice" value="${price}"
                           class="form-input unitPrice" min="0" step="0.01" /></td>

                <td><input type="number" name="ReceiptDetails[${detailIndex}].DiscountPercentage" value="${discount}"
                           class="form-input discount" min="0" max="100" step="0.01" /></td>

                <td><input type="number" name="ReceiptDetails[${detailIndex}].RefundQuantity" value="${refund}"
                           class="form-input refund" min="0" step="0.001" /></td>

                <td class="rowTotal">0.00</td>

                <td>
                    <button type="button" class="btn btn-danger btn-sm removeRow">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>`;

            $("#receiptDetailsTable tbody").append(row);
            detailIndex++;
            updateGrandTotal();
        }

        /* ----------------------- 🔥 REINDEXING FIX ----------------------- */

        function reindexDetails() {
            $("#receiptDetailsTable tbody tr").each(function(i) {
                $(this).find("input, select").each(function () {
                    let name = $(this).attr("name");
                    if (name) {
                        name = name.replace(/\[\d+\]/, `[${i}]`);
                        $(this).attr("name", name);
                    }
                });
            });

            detailIndex = $("#receiptDetailsTable tbody tr").length;
        }

        $(document).on("click", ".removeRow", function(){
            $(this).closest("tr").remove();
            reindexDetails();
            updateGrandTotal();
            saveDraft();
        });

        /* ----------------------- TOTALS ----------------------- */

        $(document).on("input", ".qty, .unitPrice, .discount, .refund, #PaidAmount", function(){
            updateGrandTotal();
            saveDraft();
        });

        function updateGrandTotal(){
            let total = 0, costTotal = 0;
            $("#receiptDetailsTable tbody tr").each(function(){
                let qty = parseFloat($(this).find(".qty").val()) || 0,
                    price = parseFloat($(this).find(".unitPrice").val()) || 0,
                    cost = parseFloat($(this).data("cost")) || 0,
                    discount = parseFloat($(this).find(".discount").val()) || 0,
                    refund = parseFloat($(this).find(".refund").val()) || 0;

                let discountedTotal = (qty - refund) * price * (1 - discount / 100);
                $(this).find(".rowTotal").text(discountedTotal.toFixed(2));

                total += discountedTotal;
                costTotal += (qty - refund) * cost;
            });

            $("#grandTotal").text(total.toFixed(2));
            $("#costTotal").text(costTotal.toFixed(2));

            let paid = parseFloat($("#PaidAmount").val()) || 0;
            $("#remainingAmount").text((total - paid).toFixed(2));
        }

        /* ----------------------- RESTORE SAVED ----------------------- */

        function addRowFromModel(item){
            let productId = item.productId ?? item.ProductId ?? 0;
            let product = products.find(p => p.id == productId);

            let productName = item.productName ?? item.ProductName ?? product?.name ?? "اسم غير معروف";
            let cost = item.cost ?? item.Cost ?? product?.cost ?? 0;
            let quantity = item.quantity ?? item.Quantity ?? 1;
            let unitPrice = item.unitPrice ?? item.UnitPrice ?? product?.price ?? 0;
            let discount = item.discountPercentage ?? item.DiscountPercentage ?? 0;
            let refund = item.refundQuantity ?? item.RefundQuantity ?? 0;

            addProductRow(productId, productName, quantity, unitPrice, cost, discount, refund);
        }

        /* ----------------------- SAVE DRAFT ----------------------- */

        function escapeHtml(text){
            return text == null ? "" : text.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function saveDraft(){
            let details = [];
            $("#receiptDetailsTable tbody tr").each(function(){
                details.push({
                    productId: $(this).data("id"),
                    quantity: $(this).find(".qty").val(),
                    unitPrice: $(this).find(".unitPrice").val(),
                    discountPercentage: $(this).find(".discount").val(),
                    refundQuantity: $(this).find(".refund").val(),
                    cost: $(this).data("cost"),
                    productName: $(this).find("td:first").text().trim(),
                });
            });

            let vm = {
                ClientId: $("#ClientId").val(),
                NewClientName: $("#NewClientName").val(),
                NewClientPhone: $("#NewClientPhone").val(),
                PlumberId: $("#PlumberId").val(),
                NewPlumberName: $("#NewPlumberName").val(),
                NewPlumberPhone: $("#NewPlumberPhone").val(),
                PaidAmount: $("#PaidAmount").val(),
                ReceiptDetails: details
            };

            $.ajax({
                url: "/Receipt/SaveOutReceiptDraft",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(vm)
            });
        }

        $(function(){
            renderProducts();

            if(Array.isArray(savedDetails) && savedDetails.length > 0){
                savedDetails.forEach(addRowFromModel);
                detailIndex = savedDetails.length;
                updateGrandTotal();
            }
        });

        window.addEventListener("beforeunload", saveDraft);
    </script>
}
