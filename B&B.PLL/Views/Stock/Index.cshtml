@using B_B.DAL.Entity
@model IEnumerable<Product>

<div class="page-content active">
    <div class="page-header">
        <h1 class="page-title">المخزون</h1>
        <div>
            <form asp-action="UpdateImport" asp-controller="Stock" method="post" enctype="multipart/form-data" class="d-inline">
                <div class="file-input-group">
                    <label for="fileInput" class="btn btn-secondary">
                        <i class="fas fa-file-import"></i> Import Excel
                    </label>
                    <input type="file" id="fileInput" name="file" accept=".xlsx,.xls" required style="display: none;"
                           onchange="this.form.submit()" />
                </div>
            </form>
                <h1 class="page-title"></h1>
                <a asp-action="Create" class="btn btn-primary">
                    <i class="fas fa-plus"></i> إضافة منتج
                </a>
        </div>
    </div>

    <div class="content-section">
        <div class="table-controls">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="البحث عن منتج ..." />
            </div>
        </div>

        <div class="table-container">
            <table class="table" id="stockTable">
                <thead>
                    <tr>
                        <th>المنتج</th>
                        <th>التكلفه</th>
                        <th>سعر البيع</th>
                        <th>المخزون الابتدائي</th>
                        <th>المخزون</th>
                        <th>مجموع التكلفه</th>
                        <th>المورد</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.Name</td>
                            <td>@($"{item.Cost:N2}")</td>
                            <td>@($"{item.SellingPrice:N2}")</td>
                            <td>@item.InitialStock</td>
                            <td>@item.Quantity</td>
                            <td>@($"{item.Cost * item.Quantity:N2}")</td>
                            <td>@item.Supplier?.Name</td>




                            <td class="action-cell">
                                <a asp-action="Edit" asp-controller="Stock" asp-route-id="@item.Id" class="action-btn edit-btn">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="action-btn delete-btn" onclick="confirmDelete(@item.Id)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <nav>
            <ul class="pagination" id="pagination"></ul>
        </nav>
        <div class="pagination-info" id="paginationInfo"></div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function confirmDelete(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: "This product will be deleted permanently!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/Stock/Delete/' + id;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const rows = Array.from(document.querySelectorAll('#tableBody tr'));
            const pageSize = 20; // 20 items per page
            let currentPage = 1;
            const maxVisiblePages = 5; // Show max 5 page numbers

            function setupPagination() {
                const searchText = document.getElementById('searchInput').value.toLowerCase();
                const filteredRows = rows.filter(row =>
                    row.textContent.toLowerCase().includes(searchText)
                );

                const totalItems = filteredRows.length;
                const pageCount = Math.ceil(totalItems / pageSize);
                const pagination = document.getElementById('pagination');
                const startItem = ((currentPage - 1) * pageSize) + 1;
                const endItem = Math.min(currentPage * pageSize, totalItems);

                // Update pagination info
                document.getElementById('paginationInfo').textContent =
                    `عرض ${startItem}-${endItem} من ${totalItems} منتج`;

                pagination.innerHTML = '';

                if (pageCount <= 1) {
                    showPage(currentPage, filteredRows);
                    return;
                }

                // Previous button (السابق) - Points RIGHT in RTL
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" data-page="prev">
                    <i class="fas fa-chevron-right"></i>
                </a>`;
                if (currentPage > 1) {
                    prevLi.addEventListener('click', function(e) {
                        e.preventDefault();
                        currentPage--;
                        setupPagination();
                    });
                }
                pagination.appendChild(prevLi);

                // Calculate start and end pages for visible range
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(pageCount, startPage + maxVisiblePages - 1);

                // Adjust if we're near the end
                if (endPage - startPage < maxVisiblePages - 1) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                // First page and ellipsis if needed
                if (startPage > 1) {
                    const firstLi = document.createElement('li');
                    firstLi.className = `page-item ${1 === currentPage ? 'active' : ''}`;
                    firstLi.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
                    firstLi.addEventListener('click', function(e) {
                        e.preventDefault();
                        currentPage = 1;
                        setupPagination();
                    });
                    pagination.appendChild(firstLi);

                    if (startPage > 2) {
                        const ellipsisLi = document.createElement('li');
                        ellipsisLi.className = 'page-item disabled';
                        ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                        pagination.appendChild(ellipsisLi);
                    }
                }

                // Page numbers
                for (let i = startPage; i <= endPage; i++) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                    li.addEventListener('click', function(e) {
                        e.preventDefault();
                        currentPage = i;
                        setupPagination();
                    });
                    pagination.appendChild(li);
                }

                // Last page and ellipsis if needed
                if (endPage < pageCount) {
                    if (endPage < pageCount - 1) {
                        const ellipsisLi = document.createElement('li');
                        ellipsisLi.className = 'page-item disabled';
                        ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                        pagination.appendChild(ellipsisLi);
                    }

                    const lastLi = document.createElement('li');
                    lastLi.className = `page-item ${pageCount === currentPage ? 'active' : ''}`;
                    lastLi.innerHTML = `<a class="page-link" href="#" data-page="${pageCount}">${pageCount}</a>`;
                    lastLi.addEventListener('click', function(e) {
                        e.preventDefault();
                        currentPage = pageCount;
                        setupPagination();
                    });
                    pagination.appendChild(lastLi);
                }

                // Next button (التالي) - Points LEFT in RTL
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentPage === pageCount ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" data-page="next">
                    <i class="fas fa-chevron-left"></i>
                </a>`;
                if (currentPage < pageCount) {
                    nextLi.addEventListener('click', function(e) {
                        e.preventDefault();
                        currentPage++;
                        setupPagination();
                    });
                }
                pagination.appendChild(nextLi);

                showPage(currentPage, filteredRows);
            }

            function showPage(page, filteredRows) {
                const start = (page - 1) * pageSize;
                const end = start + pageSize;

                // Hide all rows first
                rows.forEach(row => row.style.display = 'none');

                // Show only filtered rows for current page
                filteredRows.forEach((row, index) => {
                    row.style.display = (index >= start && index < end) ? '' : 'none';
                });
            }

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                currentPage = 1;
                setupPagination();
            });

            // Initialize
            setupPagination();
        });
    </script>
    }
@*     <style>
        
    

        /* Pagination styles */
        .pagination {
            display: flex;
            gap: 0.25rem;
            margin-top: 1.5rem;
            justify-content: center;
            list-style: none;
            padding: 0;
            flex-wrap: wrap;
        }

        .page-item {
            display: inline-block;
        }

        .page-link {
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
            text-decoration: none;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
        }

            .page-link:hover {
                background-color: var(--gray-100);
                border-color: var(--gray-400);
            }

        .page-item.active .page-link {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-color: var(--primary);
        }

        .page-item.disabled .page-link {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--gray-100);
        }

            .page-item.disabled .page-link:hover {
                background-color: var(--gray-100);
                border-color: var(--gray-300);
            }

        .pagination-info {
            text-align: center;
            margin-top: 0.5rem;
            color: var(--gray-600);
            font-size: 0.875rem;
        }

      

        /* File input styling */
        .file-input-group {
            display: inline-block;
            position: relative;
        }

        /* Responsive adjustments */
        @@media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .action-cell {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .search-bar {
                max-width: 100%;
            }

            .table-container {
                overflow-x: auto;
            }

            .pagination {
                gap: 0.125rem;
            }

            .page-link {
                padding: 0.375rem 0.5rem;
                min-width: 36px;
                font-size: 0.875rem;
            }
        }

        @@media (max-width: 480px) {
            .pagination {
                flex-wrap: wrap;
            }

            .page-item {
                margin-bottom: 0.25rem;
            }
        }
    </style>
} *@